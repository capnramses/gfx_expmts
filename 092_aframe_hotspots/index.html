<html>
<!-- NOTE(Anton) A-Frame works on the Oculus Rift which suggests good handling of WebXR/WebVR fallback by A-Frame -->

<head>
	<meta charset="UTF-8">
	<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
</head>

<body>

	<script>
		function create_hotspot(id_attrib, text) {
			var sceneEl = document.querySelector('a-scene');
			var entityEl = document.createElement('a-entity');
			// Do `.setAttribute()`s to initialize the entity.
			entityEl.setAttribute("geometry", "primitive: plane; width: 4; height: auto");
			entityEl.setAttribute("material", "color: green; opacity:0.66; transparent: true");
			entityEl.setAttribute("text", "value: " + text); // NOTE(Anton) use of "value:" here in text attrib
			entityEl.setAttribute("position", "2 2 -1");
			entityEl.setAttribute("rotation", "0 90 0"); // NOTE(Anton) degrees
			entityEl.setAttribute("id", id_attrib); // NOTE(Anton) degrees
			console.log(entityEl);
			sceneEl.appendChild(entityEl);

		}

		console.log("registering components...");
		// "As the most basic example, to register a console.log component before <a-scene>:"
		AFRAME.registerComponent('log', {
			schema: { type: 'string' },

			init: function () {
				var stringToLog = this.data;
				console.log(stringToLog);
			}
		});

		// just checking i can also modify text as a component of an existing text element in the scene
		AFRAME.registerComponent('modify_text', {
			schema: { type: 'string' },

			init: function () {
				var stringToLog = this.data;
				console.log(stringToLog);
				this.el.setAttribute("material", "color: red;");
				var text = "custom text modified by my component in init()"
				this.el.setAttribute("text", "value: " + text);
			}
		});

		/* TODO(Anton)
		* -- get /all/ the hotspots
		* -- also have a location xyz and rotation column
		* -- loop over and create them all
		*/

		AFRAME.registerComponent('json_text',
			{
				init: function () {

					var ajaxRequest = new XMLHttpRequest();
					ajaxRequest.onreadystatechange = function () {
						if (ajaxRequest.readyState == 4) {
							console.log("Ready state changed!");
							var jsonObj = JSON.parse(ajaxRequest.responseText);

							console.log(jsonObj.hotspots[0].text);

							create_hotspot("hotspot_text0", jsonObj.hotspots[0].text);
						}
					}
					ajaxRequest.open("GET", "test.json", true);
					ajaxRequest.send();

				}
			}
		);
	</script>

	<a-scene log="Hello, Scene!" json_text>
		<!-- note the hello scene component log executes /after/ the scene has loaded -->

		<!-- NOTE(Anton) assets are loaded before displaying the scene. loading inline with eg <a-entity gltf-model="url(/path/to/tree.gltf)"></a-entity> won't wait -->
		<a-assets>
			<a-asset-item id="sponza" src="../common/meshes/Sponza/glTF/Sponza.gltf"></a-asset-item>
			<a-asset-item id="infopoint" src="infopoint.glb"></a-asset-item>
		</a-assets>

		<a-entity gltf-model="#sponza"></a-entity>
		<a-entity gltf-model="#infopoint" scale="0.5 0.5 0.5" position="0 2 0"></a-entity>
		<!--
			<a-entity obj-model="obj: url(infopoint.obj); mtl: url(infopoint.mtl)" scale="0.5 0.5 0.5" position="0 2 0">		
		</a-entity>
-->

		<!-- note: onload doesnt work here  -->
		<a-entity geometry="primitive: plane; width: 4; height: auto" material="color: green; opacity:0.66;
			transparent:true" text="value: This text will be 4 units wide." position=" 2 4 -1 " rotation="0 90 0" id="my_text"
			modify_text>
		</a-entity>


		<!-- And after the registration, use the component from HTML: -->
		<a-box log="Hello, Box!"></a-box>
		<!-- NOTE this log displays before the scene is loaded and the scene's log displays -->


	</a-scene>
</body>

</html>

<script>
	// NOTE(Anton) needed to specify .mtl before .obj was visible in scene
	// NOTE(Anton) when my .obj was quads A-Frame incorrectly triangulated it so it was inside-out. had to pre-triangulate
	// NOTE(Anton) needed newest Blender for reliable GLB export
	// NOTE(Anton) GLTF looks matte, OBJ looks shiny - this could be a PBR/Phong difference
	// NOTE(Anton) read this about setting up JS for a-frame: https://aframe.io/docs/1.0.0/introduction/javascript-events-dom-apis.html

	// "Do not try to put A-Frame-related JavaScript in a raw <script> tag after <a-scene> as we would with traditional 2D scripting. If we do, weâ€™d have to take special measures to make sure code runs at the right time"


	// TODO(Anton) function to get cam pos and distance from markers and transition to content
</script>